
{% load i18n %}
{% load static %}


{% include "includes/head.html" with title="Cycle" %}

{% include "includes/menu_game.html" with page_title=_("Cycle") %}  <!-- include body start -->

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <!--<h1>{% trans ""%} </h1>-->
          </div>
        </div>
      </div><!-- /.container-fluid -->
    </section>

    <!-- Main content -->
    <section class="content">

        <!--------------------------------------------------------------------------------------------------------->
        <!-- Corps central -->

      <div class="container-fluid">

        <!----------------------------------------------------------------------------------------------------------->
        <!-- CYCLE INFOS AND ACTIONS -->
        <!----------------------------------------------------------------------------------------------------------->

        <div class="row">
          <div class="col-lg-6">

            {% if current_commandant_absent %}
              <div class="alert alert-info">
                <h5><i class="icon fas fa-moon"></i> {% trans "Vous êtes en mode absent." %}</h5>
                {% trans "Si vous n'êtes plus disponible pour commander, le reste de la galaxie ne sera pas bloqué par votre inactivité." %}
                {% trans "Tant que vous ne retirez pas le mode absent, vous serez systématiquement considéré comme ayant terminé votre cycle." %}
              </div>
            {% elif not current_commandant_finished %}
              <div class="alert alert-danger">
                <h5><i class="icon fas fa-hourglass-end"></i> {% trans "Vous n'êtes pas prêt pour le cycle suivant." %}</h5>
                {% trans "Vous n'avez pas encore terminé de donner des ordres pour ce cycle. N'oubliez pas de signaler lorsque vous avez fini." %}
                {% trans "Si vous prenez un temps déraisonnable, le Maître du Jeu peut forcer le passage de cycle, voire vous déclarer absent en cas d'abus." %}
              </div>
            {% elif current_commandant_finished %}
              <div class="alert alert-success">
                <h5><i class="icon fas fa-check"></i> {% trans "Vous êtes prêt pour le cycle suivant." %}</h5>
                {% trans "Lorsque tous les autres commandants auront également terminé leur cycle, le maître du jeu passera au cycle suivant." %}
                {% trans "Vous pouvez pendant ce temps continuer à donner des ordres, mais vous risquez d'être interrompu par le changement de cycle." %}
              </div>
            {% endif %}

          </div>
          <div class="col-lg-6">

            {% if not current_commandant_finished %}
              <button type="button" class="btn btn-block btn-outline-success btn-lg" style="height: 42%;"
                      onclick="window.location.href='/cycle_monitoring/?commandant_cycle_status=commandant_cycle_finished';">
                <i class="icon fas fa-check"></i> {% trans "Se déclarer prêt pour la fin de cycle" %}
              </button>
            {% else %}
              <button type="button" class="btn btn-block btn-outline-warning btn-lg" style="height: 42%;"
                      onclick="window.location.href='/cycle_monitoring/?commandant_cycle_status=commandant_cycle_playing';">
                <i class="icon fas fa-hourglass-end"></i> {% trans "Se déclarer pas encore prêt pour la fin du cycle" %}
              </button>
            {% endif %}

            {% if not current_commandant_absent %}
              <button type="button" class="btn btn-block btn-outline-info btn-lg" style="height: 42%;"
                      onclick="window.location.href='/cycle_monitoring/?commandant_cycle_presence=commandant_cycle_absent';">
                <i class="icon fas fa-moon"></i> {% trans "Se mettre en mode absent" %}
              </button>
            {% else %}
              <button type="button" class="btn btn-block btn-outline-info btn-lg" style="height: 42%;"
                      onclick="window.location.href='/cycle_monitoring/?commandant_cycle_presence=commandant_cycle_present';">
                <i class="icon fas fa-sun"></i> {% trans "Retirer le mode absent" %}
              </button>
            {% endif %}

          </div>

        </div>


        <!----------------------------------------------------------------------------------------------------------->
        <!-- END CYCLE (ADMIN BUTTON) -->
        <!----------------------------------------------------------------------------------------------------------->

        {% if display_admin_and_gm_info %}
          {% if ratio_finished != 1 %} <!-- Not all players have finished the cycle -->
            <button type="button" style="margin-top: 20px;margin-bottom: 20px;"
                    class="btn btn-block btn-outline-warning btn-lg"
                    onclick="if(confirm('/!\\ {% trans "Tous les commandants ne sont pas encore prêts pour changer de cycle. Forcer la fin du cycle ?" %}'))
                        {window.location.href='/cycle_monitoring/?admin_action=end_cycle';                      }
                    ">
              {% trans "[ADMIN/MG]" %} {% trans "Passer au cycle suivant" %}
            </button>

          {% else %} <!-- All players finished the cycle -->
          <button type="button" style="margin-top: 20px;margin-bottom: 20px;"
                  class="btn btn-block btn-outline-success btn-lg"
                  onclick="window.location.href='/cycle_monitoring/?admin_action=end_cycle';">
            {% trans "[ADMIN/MG]" %} {% trans "Passer au cycle suivant" %}
            </button>
          {% endif %}
        {% endif %}


        <div class="row">

          <!----------------------------------------------------------------------------------------------------------->
          <!-- PLAYER NOT FINISHED -->
          <!----------------------------------------------------------------------------------------------------------->

          <div class="col-lg-6">

            <div class="card card-primary card-outline">
              <div class="card-header">
                <h5 class="m-0">{% trans "Commandants n'ayant pas terminé leur cycle"%}
                              (
                              {{commandants_cycle_playing|length}}
                              /
                              {% with len_playing=commandants_cycle_playing|length %}{% with len_finished=commandants_cycle_finished|length %}{{ len_playing|add:len_finished }}{% endwith %} {% endwith %}
                              )
                </h5>
              </div>

                <div class="card-body">
                  {% for commandant in commandants_cycle_playing %}

                    <!-- Post -->
                    <div class="post" style="border-bottom:0px;">
                      <div class="user-block menu-separator row align-items-center" style="margin-top:5px; padding-bottom:10px; margin-bottom: 5px;">

                        <!-- Avatar and flag -->
                        <div class="col-12 col-md-2 d-flex align-items-center">
                          <img class="img-bordered-sm me-2" src="{% static "" %}{{ commandant.flag }}"
                               style="height:60px; width:60px;">
                          <img class="img-bordered-sm" src="{% static "" %}{{ commandant.portrait }}"
                               style="height:60px; width:60px; margin-left:10px;">
                        </div>

                        <!-- Commandant and civilisation names -->
                        <div class="col-12 {% if admin_or_gm_only %}col-md-5{% else %}col-md-10{% endif %}  align-items-center">
                          <span class="username d-block mb-2" style="font-size:18px;">
                            {{ commandant.commandant_name }}
                            <br/>
                            {{ commandant.civilisation_name }}
                          </span>
                        </div>

                        <!-- Admin/GM info -->
                        {% if admin_or_gm_only %}
                        <div class="col-12 col-md-5  align-items-center">
                          <span class="d-block" style="font-size:14px;">
                            {% trans "Dernière action :" %} ? minutes
                          </span>
                          <span class="d-block" style="font-size:14px;">
                            <a href="#" class="text-warning" style="text-decoration: underline;">
                              {% trans "Passer en mode absent" %} <!-- TODO absent mode -->
                            </a>
                          </span>
                        </div>
                        {% endif %}

                      </div>
                      <!-- /.user-block -->
                    </div>
                    <!-- /.post -->

                  {% endfor %}
                </div>

            </div>
          </div>
          <!-- /.col-md-6 -->

          <!----------------------------------------------------------------------------------------------------------->
          <!-- PLAYER WAITING FOR NEXT TURN-->
          <!----------------------------------------------------------------------------------------------------------->


          <div class="col-lg-6">

            <div class="card card-primary card-outline">
              <div class="card-header">
                <h5 class="m-0">{% trans "Commandants en attente du cycle suivant"%}
                              (
                              {{commandants_cycle_finished|length}}
                              /
                              {% with len_playing=commandants_cycle_playing|length %}{% with len_finished=commandants_cycle_finished|length %}{{ len_playing|add:len_finished }}{% endwith %} {% endwith %}
                              )
                </h5>
              </div>

                <div class="card-body">
                  {% for commandant in commandants_cycle_finished %}

                    <!-- Post -->
                    <div class="post" style="border-bottom:0px;">
                      <div class="user-block menu-separator row align-items-center" style="margin-top:5px; padding-bottom:10px; margin-bottom: 5px;">

                        <!-- Avatar and flag -->
                        <div class="col-12 col-md-2 d-flex align-items-center">
                          <img class="img-bordered-sm me-2" src="{% static "" %}{{ commandant.flag }}"
                               style="height:60px; width:60px;">
                          <img class="img-bordered-sm" src="{% static "" %}{{ commandant.portrait }}"
                               style="height:60px; width:60px; margin-left:10px;">
                        </div>

                        <!-- Commandant and civilisation names -->
                        <div class="col-12 {% if admin_or_gm_only %}col-md-5{% else %}col-md-10{% endif %}  align-items-center">
                          <span class="username d-block mb-2" style="font-size:18px;">
                            {{ commandant.commandant_name }}
                            <br/>
                            {{ commandant.civilisation_name }}
                          </span>
                        </div>

                        <!-- Admin/GM info -->
                        {% if admin_or_gm_only %}
                        <div class="col-12 col-md-5  align-items-center">
                          {{ commandant.time_cycle_finished|date:'c' }}
                          <span class="d-block" style="font-size:14px;">
                              {% trans "Terminé depuis :" %}
                              <span class="timeago"
                                    data-timestamp="{{ commandant.time_cycle_finished|date:'c' }}"
                                    data-lang="{{ user.language }}"></span>
                          </span>
                          <span class="d-block" style="font-size:14px;">
                            {% trans "Dernière action :" %} ? minutes
                          </span>
                        </div>
                        {% endif %}

                      </div>
                      <!-- /.user-block -->
                    </div>
                    <!-- /.post -->

                  {% endfor %}
                </div>

            </div>
          </div>
          <!-- /.col-md-6 -->
        </div>
        <!-- /.row -->
      </div>


    </section>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->


  <script>

    // TIMERS SCRIPT
    // /!\ Code ChatGPT

    document.addEventListener("DOMContentLoaded", function() {
        dayjs.extend(dayjs_plugin_relativeTime)
        dayjs.extend(dayjs_plugin_utc)

        // Récupérer la langue (fallback navigateur)
        const userLang = document.querySelector('.timeago')?.dataset.lang || navigator.language.split('-')[0] || 'fr';
        dayjs.locale(userLang);

        function updateTimeago() {
            document.querySelectorAll('.timeago').forEach(el => {
                const ts = dayjs.utc(el.dataset.timestamp).local(); // UTC -> local
                el.innerText = `${ts.fromNow()}`;                  // affichage relatif
                el.title = ts.format("DD/MM/YYYY HH:mm");          // infobulle date exacte
            })
        }

        updateTimeago()
        setInterval(updateTimeago, 1000)
    })
  </script>

</body>
</html>
